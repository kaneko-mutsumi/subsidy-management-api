
========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\api\DocumentController.java ==========

package com.example.subsidy_management_api.api;

import com.example.subsidy_management_api.api.dto.DocumentCreateRequest;
import com.example.subsidy_management_api.api.dto.DocumentCreateResponse;
import com.example.subsidy_management_api.api.dto.DocumentDraftResponse;
import com.example.subsidy_management_api.api.dto.DocumentIssueRequest;
import com.example.subsidy_management_api.api.dto.DocumentIssueResponse;
import com.example.subsidy_management_api.api.dto.DocumentListItem;
import com.example.subsidy_management_api.domain.DocumentType;
import com.example.subsidy_management_api.service.DocumentDraftService;
import com.example.subsidy_management_api.service.DocumentIssueService;
import com.example.subsidy_management_api.service.DocumentService;
import jakarta.validation.Valid;
import java.util.List;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseStatus;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/documents")
public class DocumentController {

  private final DocumentService service;
  private final DocumentDraftService draftService;
  private final DocumentIssueService issueService;

  public DocumentController(DocumentService service, DocumentDraftService draftService, DocumentIssueService issueService) {
    this.service = service;
    this.draftService = draftService;
    this.issueService = issueService;
  }

  @PostMapping
  @ResponseStatus(HttpStatus.CREATED)
  public DocumentCreateResponse create(@Valid @RequestBody DocumentCreateRequest req) {
    return service.create(req);
  }

  @GetMapping
  public List<DocumentListItem> list(@RequestParam long applicationId) {
    return service.list(applicationId);
  }

  @GetMapping("/draft")
  public DocumentDraftResponse draft(
      @RequestParam long applicationId,
      @RequestParam DocumentType documentType
  ) {
    return draftService.draft(applicationId, documentType);
  }

  @PostMapping("/issue")
  @ResponseStatus(HttpStatus.CREATED)
  public DocumentIssueResponse issue(@Valid @RequestBody DocumentIssueRequest req) {
    return issueService.issue(req);
  }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\api\dto\ApiErrorResponse.java ==========

package com.example.subsidy_management_api.api.dto;

import java.time.OffsetDateTime;

public class ApiErrorResponse {
  private String code;
  private String message;
  private OffsetDateTime timestamp;

  public ApiErrorResponse(String code, String message, OffsetDateTime timestamp) {
    this.code = code;
    this.message = message;
    this.timestamp = timestamp;
  }

  public String getCode() { return code; }
  public String getMessage() { return message; }
  public OffsetDateTime getTimestamp() { return timestamp; }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\api\dto\DocumentCreateRequest.java ==========

package com.example.subsidy_management_api.api.dto;

import com.example.subsidy_management_api.domain.DocumentType;
import jakarta.validation.constraints.NotNull;
import jakarta.validation.constraints.Size;

import java.util.Map;

public class DocumentCreateRequest {

  @NotNull
  private Long applicationId;

  @NotNull
  private DocumentType documentType;

  @Size(max = 50)
  private String documentNo;

  @Size(max = 100)
  private String issuedBy;

  // 差し込み用（帳票に入れる値）をJSONとして保持する
  private Map<String, Object> payload;

  public Long getApplicationId() { return applicationId; }
  public void setApplicationId(Long applicationId) { this.applicationId = applicationId; }

  public DocumentType getDocumentType() { return documentType; }
  public void setDocumentType(DocumentType documentType) { this.documentType = documentType; }

  public String getDocumentNo() { return documentNo; }
  public void setDocumentNo(String documentNo) { this.documentNo = documentNo; }

  public String getIssuedBy() { return issuedBy; }
  public void setIssuedBy(String issuedBy) { this.issuedBy = issuedBy; }

  public Map<String, Object> getPayload() { return payload; }
  public void setPayload(Map<String, Object> payload) { this.payload = payload; }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\api\dto\DocumentCreateResponse.java ==========

package com.example.subsidy_management_api.api.dto;

import java.time.OffsetDateTime;

public class DocumentCreateResponse {
  private long documentId;
  private long applicationId;
  private String documentType;
  private OffsetDateTime issuedAt;

  public DocumentCreateResponse(long documentId, long applicationId, String documentType, OffsetDateTime issuedAt) {
    this.documentId = documentId;
    this.applicationId = applicationId;
    this.documentType = documentType;
    this.issuedAt = issuedAt;
  }

  public long getDocumentId() { return documentId; }
  public long getApplicationId() { return applicationId; }
  public String getDocumentType() { return documentType; }
  public OffsetDateTime getIssuedAt() { return issuedAt; }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\api\dto\DocumentDraftResponse.java ==========

package com.example.subsidy_management_api.api.dto;

import java.util.Map;

public class DocumentDraftResponse {
  private long applicationId;
  private String documentType;
  private Map<String, Object> payload;

  public DocumentDraftResponse(long applicationId, String documentType, Map<String, Object> payload) {
    this.applicationId = applicationId;
    this.documentType = documentType;
    this.payload = payload;
  }

  public long getApplicationId() { return applicationId; }
  public String getDocumentType() { return documentType; }
  public Map<String, Object> getPayload() { return payload; }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\api\dto\DocumentIssueRequest.java ==========

package com.example.subsidy_management_api.api.dto;

import com.example.subsidy_management_api.domain.DocumentType;
import jakarta.validation.constraints.NotNull;
import jakarta.validation.constraints.Size;

import java.util.Map;

public class DocumentIssueRequest {

  @NotNull
  private Long applicationId;

  @NotNull
  private DocumentType documentType;

  @Size(max = 50)
  private String documentNo;

  @Size(max = 100)
  private String issuedBy;

  // Draftに対して上書きしたい値（不足分だけ渡す想定）
  private Map<String, Object> overridesPayload;

  public Long getApplicationId() { return applicationId; }
  public void setApplicationId(Long applicationId) { this.applicationId = applicationId; }

  public DocumentType getDocumentType() { return documentType; }
  public void setDocumentType(DocumentType documentType) { this.documentType = documentType; }

  public String getDocumentNo() { return documentNo; }
  public void setDocumentNo(String documentNo) { this.documentNo = documentNo; }

  public String getIssuedBy() { return issuedBy; }
  public void setIssuedBy(String issuedBy) { this.issuedBy = issuedBy; }

  public Map<String, Object> getOverridesPayload() { return overridesPayload; }
  public void setOverridesPayload(Map<String, Object> overridesPayload) { this.overridesPayload = overridesPayload; }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\api\dto\DocumentIssueResponse.java ==========

package com.example.subsidy_management_api.api.dto;

import java.time.OffsetDateTime;
import java.util.Map;

public class DocumentIssueResponse {
  private long documentId;
  private long applicationId;
  private String documentType;
  private OffsetDateTime issuedAt;
  private Map<String, Object> payload;

  public DocumentIssueResponse(long documentId, long applicationId, String documentType, OffsetDateTime issuedAt, Map<String, Object> payload) {
    this.documentId = documentId;
    this.applicationId = applicationId;
    this.documentType = documentType;
    this.issuedAt = issuedAt;
    this.payload = payload;
  }

  public long getDocumentId() { return documentId; }
  public long getApplicationId() { return applicationId; }
  public String getDocumentType() { return documentType; }
  public OffsetDateTime getIssuedAt() { return issuedAt; }
  public Map<String, Object> getPayload() { return payload; }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\api\dto\DocumentListItem.java ==========

package com.example.subsidy_management_api.api.dto;

import java.time.OffsetDateTime;

public class DocumentListItem {
  private long documentId;
  private long applicationId;
  private String documentType;
  private String documentNo;
  private String issuedBy;
  private OffsetDateTime issuedAt;

  public long getDocumentId() { return documentId; }
  public void setDocumentId(long documentId) { this.documentId = documentId; }

  public long getApplicationId() { return applicationId; }
  public void setApplicationId(long applicationId) { this.applicationId = applicationId; }

  public String getDocumentType() { return documentType; }
  public void setDocumentType(String documentType) { this.documentType = documentType; }

  public String getDocumentNo() { return documentNo; }
  public void setDocumentNo(String documentNo) { this.documentNo = documentNo; }

  public String getIssuedBy() { return issuedBy; }
  public void setIssuedBy(String issuedBy) { this.issuedBy = issuedBy; }

  public OffsetDateTime getIssuedAt() { return issuedAt; }
  public void setIssuedAt(OffsetDateTime issuedAt) { this.issuedAt = issuedAt; }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\api\dto\ReportStatusBreakdownItem.java ==========

package com.example.subsidy_management_api.api.dto;

public class ReportStatusBreakdownItem {
  private String status;
  private long count;
  private long totalAmountRequested;

  public ReportStatusBreakdownItem(String status, long count, long totalAmountRequested) {
    this.status = status;
    this.count = count;
    this.totalAmountRequested = totalAmountRequested;
  }

  public String getStatus() { return status; }
  public long getCount() { return count; }
  public long getTotalAmountRequested() { return totalAmountRequested; }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\api\dto\ReportSummaryResponse.java ==========

package com.example.subsidy_management_api.api.dto;

import java.time.LocalDate;

public class ReportSummaryResponse {
  private LocalDate from;
  private LocalDate to;
  private String status;
  private long count;
  private long totalAmountRequested;

  public ReportSummaryResponse(LocalDate from, LocalDate to, String status, long count, long totalAmountRequested) {
    this.from = from;
    this.to = to;
    this.status = status;
    this.count = count;
    this.totalAmountRequested = totalAmountRequested;
  }

  public LocalDate getFrom() { return from; }
  public LocalDate getTo() { return to; }
  public String getStatus() { return status; }
  public long getCount() { return count; }
  public long getTotalAmountRequested() { return totalAmountRequested; }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\api\dto\SubsidyApplicationCreateRequest.java ==========

package com.example.subsidy_management_api.api.dto;

import com.example.subsidy_management_api.domain.ApplicationStatus;
import jakarta.validation.Valid;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import jakarta.validation.constraints.Positive;

public class SubsidyApplicationCreateRequest {

  @NotNull
  @Valid
  private ApplicantInput applicant;

  @NotNull
  @Valid
  private ApplicationInput application;

  public ApplicantInput getApplicant() {
    return applicant;
  }

  public void setApplicant(ApplicantInput applicant) {
    this.applicant = applicant;
  }

  public ApplicationInput getApplication() {
    return application;
  }

  public void setApplicationInput(ApplicationInput application) {
    this.application = application;
  }

  public void setApplication(ApplicationInput application) {
    this.application = application;
  }

  public static class ApplicantInput {

    @NotBlank
    private String fullName;

    private String fullNameKana;
    private String email;
    private String phone;
    private String postalCode;
    private String address1;
    private String address2;

    public String getFullName() {
      return fullName;
    }

    public void setFullName(String fullName) {
      this.fullName = fullName;
    }

    public String getFullNameKana() {
      return fullNameKana;
    }

    public void setFullNameKana(String fullNameKana) {
      this.fullNameKana = fullNameKana;
    }

    public String getEmail() {
      return email;
    }

    public void setEmail(String email) {
      this.email = email;
    }

    public String getPhone() {
      return phone;
    }

    public void setPhone(String phone) {
      this.phone = phone;
    }

    public String getPostalCode() {
      return postalCode;
    }

    public void setPostalCode(String postalCode) {
      this.postalCode = postalCode;
    }

    public String getAddress1() {
      return address1;
    }

    public void setAddress1(String address1) {
      this.address1 = address1;
    }

    public String getAddress2() {
      return address2;
    }

    public void setAddress2(String address2) {
      this.address2 = address2;
    }
  }

  public static class ApplicationInput {

    @NotBlank
    private String applicationDate; // まずは文字列で受ける（最短）

    @NotNull
    @Positive
    private Long amountRequested;

    @NotNull
    private ApplicationStatus status;

    public String getApplicationDate() {
      return applicationDate;
    }

    public void setApplicationDate(String applicationDate) {
      this.applicationDate = applicationDate;
    }

    public Long getAmountRequested() {
      return amountRequested;
    }

    public void setAmountRequested(Long amountRequested) {
      this.amountRequested = amountRequested;
    }

    public ApplicationStatus getStatus() {
      return status;
    }

    public void setStatus(ApplicationStatus status) {
      this.status = status;
    }
  }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\api\dto\SubsidyApplicationCreateResponse.java ==========

package com.example.subsidy_management_api.api.dto;

public class SubsidyApplicationCreateResponse {
  private long applicantId;
  private long applicationId;

  public SubsidyApplicationCreateResponse(long applicantId, long applicationId) {
    this.applicantId = applicantId;
    this.applicationId = applicationId;
  }

  public long getApplicantId() { return applicantId; }
  public long getApplicationId() { return applicationId; }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\api\dto\SubsidyApplicationDetailResponse.java ==========

package com.example.subsidy_management_api.api.dto;

import java.time.LocalDate;

public class SubsidyApplicationDetailResponse {
  private long applicationId;
  private long applicantId;

  private String applicantFullName;
  private String applicantFullNameKana;
  private String applicantEmail;
  private String applicantPhone;
  private String applicantPostalCode;
  private String applicantAddress1;
  private String applicantAddress2;

  private LocalDate applicationDate;
  private long amountRequested;
  private String status;
  private LocalDate decisionDate;
  private Long approvedAmount;
  private LocalDate paidDate;
  private String note;

  public SubsidyApplicationDetailResponse(
      long applicationId,
      long applicantId,
      String applicantFullName,
      String applicantFullNameKana,
      String applicantEmail,
      String applicantPhone,
      String applicantPostalCode,
      String applicantAddress1,
      String applicantAddress2,
      LocalDate applicationDate,
      long amountRequested,
      String status,
      LocalDate decisionDate,
      Long approvedAmount,
      LocalDate paidDate,
      String note
  ) {
    this.applicationId = applicationId;
    this.applicantId = applicantId;
    this.applicantFullName = applicantFullName;
    this.applicantFullNameKana = applicantFullNameKana;
    this.applicantEmail = applicantEmail;
    this.applicantPhone = applicantPhone;
    this.applicantPostalCode = applicantPostalCode;
    this.applicantAddress1 = applicantAddress1;
    this.applicantAddress2 = applicantAddress2;
    this.applicationDate = applicationDate;
    this.amountRequested = amountRequested;
    this.status = status;
    this.decisionDate = decisionDate;
    this.approvedAmount = approvedAmount;
    this.paidDate = paidDate;
    this.note = note;
  }

  public long getApplicationId() { return applicationId; }
  public long getApplicantId() { return applicantId; }
  public String getApplicantFullName() { return applicantFullName; }
  public String getApplicantFullNameKana() { return applicantFullNameKana; }
  public String getApplicantEmail() { return applicantEmail; }
  public String getApplicantPhone() { return applicantPhone; }
  public String getApplicantPostalCode() { return applicantPostalCode; }
  public String getApplicantAddress1() { return applicantAddress1; }
  public String getApplicantAddress2() { return applicantAddress2; }
  public LocalDate getApplicationDate() { return applicationDate; }
  public long getAmountRequested() { return amountRequested; }
  public String getStatus() { return status; }
  public LocalDate getDecisionDate() { return decisionDate; }
  public Long getApprovedAmount() { return approvedAmount; }
  public LocalDate getPaidDate() { return paidDate; }
  public String getNote() { return note; }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\api\dto\SubsidyApplicationListItem.java ==========

package com.example.subsidy_management_api.api.dto;

import java.time.LocalDate;

public class SubsidyApplicationListItem {
  private long applicationId;
  private long applicantId;
  private String applicantFullName;
  private LocalDate applicationDate;
  private long amountRequested;
  private String status;

  public SubsidyApplicationListItem(long applicationId, long applicantId, String applicantFullName,
      LocalDate applicationDate, long amountRequested, String status) {
    this.applicationId = applicationId;
    this.applicantId = applicantId;
    this.applicantFullName = applicantFullName;
    this.applicationDate = applicationDate;
    this.amountRequested = amountRequested;
    this.status = status;
  }

  public long getApplicationId() { return applicationId; }
  public long getApplicantId() { return applicantId; }
  public String getApplicantFullName() { return applicantFullName; }
  public LocalDate getApplicationDate() { return applicationDate; }
  public long getAmountRequested() { return amountRequested; }
  public String getStatus() { return status; }

public SubsidyApplicationListItem() {
}

public void setApplicationId(long applicationId) { this.applicationId = applicationId; }
public void setApplicantId(long applicantId) { this.applicantId = applicantId; }
public void setApplicantFullName(String applicantFullName) { this.applicantFullName = applicantFullName; }
public void setApplicationDate(LocalDate applicationDate) { this.applicationDate = applicationDate; }
public void setAmountRequested(long amountRequested) { this.amountRequested = amountRequested; }
public void setStatus(String status) { this.status = status; }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\api\dto\SubsidyApplicationListResponse.java ==========

package com.example.subsidy_management_api.api.dto;

import java.util.List;

public class SubsidyApplicationListResponse {

  private final List<SubsidyApplicationListItem> items;
  private final long total;
  private final int limit;
  private final int offset;
  private final String sort;

  public SubsidyApplicationListResponse(
      List<SubsidyApplicationListItem> items,
      long total,
      int limit,
      int offset,
      String sort
  ) {
    this.items = items;
    this.total = total;
    this.limit = limit;
    this.offset = offset;
    this.sort = sort;
  }

  public List<SubsidyApplicationListItem> getItems() {
    return items;
  }

  public long getTotal() {
    return total;
  }

  public int getLimit() {
    return limit;
  }

  public int getOffset() {
    return offset;
  }

  public String getSort() {
    return sort;
  }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\api\GlobalExceptionHandler.java ==========

package com.example.subsidy_management_api.api;

import com.example.subsidy_management_api.api.dto.ApiErrorResponse;
import com.example.subsidy_management_api.exception.NotFoundException;
import java.time.OffsetDateTime;
import org.springframework.http.HttpStatus;
import org.springframework.http.converter.HttpMessageNotReadableException;
import org.springframework.validation.BindException;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.ResponseStatus;
import org.springframework.web.bind.annotation.RestControllerAdvice;

@RestControllerAdvice
public class GlobalExceptionHandler {

  @ExceptionHandler(NotFoundException.class)
  @ResponseStatus(HttpStatus.NOT_FOUND)
  public ApiErrorResponse handleNotFound(NotFoundException ex) {
    return new ApiErrorResponse("NOT_FOUND", ex.getMessage(), OffsetDateTime.now());
  }

  @ExceptionHandler({MethodArgumentNotValidException.class, BindException.class})
  @ResponseStatus(HttpStatus.BAD_REQUEST)
  public ApiErrorResponse handleValidation(Exception ex) {
    return new ApiErrorResponse("BAD_REQUEST", "Validation failed", OffsetDateTime.now());
  }

  @ExceptionHandler(IllegalArgumentException.class)
  @ResponseStatus(HttpStatus.BAD_REQUEST)
  public ApiErrorResponse handleIllegalArgument(IllegalArgumentException ex) {
    return new ApiErrorResponse("BAD_REQUEST",ex.getMessage(),java.time.OffsetDateTime.now()
    );
  }

  @ExceptionHandler(HttpMessageNotReadableException.class)
  @ResponseStatus(HttpStatus.BAD_REQUEST)
  public ApiErrorResponse handleNotReadable(HttpMessageNotReadableException ex) {
    return new ApiErrorResponse("BAD_REQUEST", "Invalid request body", OffsetDateTime.now());
  }

  @ExceptionHandler(Exception.class)
  @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
  public ApiErrorResponse handleUnexpected(Exception ex) {
    return new ApiErrorResponse("INTERNAL_ERROR", "Unexpected error", OffsetDateTime.now());
  }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\api\ReportController.java ==========

package com.example.subsidy_management_api.api;

import com.example.subsidy_management_api.api.dto.ReportStatusBreakdownItem;
import com.example.subsidy_management_api.api.dto.ReportSummaryResponse;
import com.example.subsidy_management_api.service.ReportService;
import java.util.List;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/reports")
public class ReportController {

  private final ReportService service;

  public ReportController(ReportService service) {
    this.service = service;
  }

  @GetMapping("/summary")
  public ReportSummaryResponse summary(
      @RequestParam(required = false) String from,
      @RequestParam(required = false) String to,
      @RequestParam(required = false) String status
  ) {
    return service.summary(from, to, status);
  }

  @GetMapping("/breakdown")
  public List<ReportStatusBreakdownItem> breakdown(
      @RequestParam(required = false) String from,
      @RequestParam(required = false) String to
  ) {
    return service.breakdown(from, to);
  }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\api\SubsidyApplicationController.java ==========

package com.example.subsidy_management_api.api;

import com.example.subsidy_management_api.api.dto.SubsidyApplicationCreateRequest;
import com.example.subsidy_management_api.api.dto.SubsidyApplicationCreateResponse;
import com.example.subsidy_management_api.api.dto.SubsidyApplicationDetailResponse;
import com.example.subsidy_management_api.api.dto.SubsidyApplicationListResponse;
import com.example.subsidy_management_api.service.SubsidyApplicationService;
import jakarta.validation.Valid;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/subsidy-applications")
public class SubsidyApplicationController {

  private final SubsidyApplicationService service;

  public SubsidyApplicationController(SubsidyApplicationService service) {
    this.service = service;
  }

  @PostMapping
  @ResponseStatus(HttpStatus.CREATED)
  public SubsidyApplicationCreateResponse create(
      @Valid @RequestBody SubsidyApplicationCreateRequest request
  ) {
    return service.create(request);
  }

  @GetMapping
  public SubsidyApplicationListResponse list(
      @RequestParam(required = false) String status,
      @RequestParam(required = false) String from,
      @RequestParam(required = false) String to,
      @RequestParam(required = false) String q,
      @RequestParam(required = false) Integer limit,
      @RequestParam(required = false) Integer offset,
      @RequestParam(required = false) String sort
  ) {
    return service.findList(status, from, to, q, limit, offset, sort);
  }

  @GetMapping("/{id}")
  public SubsidyApplicationDetailResponse detail(@PathVariable long id) {
    return service.findDetail(id);
  }

  @DeleteMapping("/{id}")
  @ResponseStatus(HttpStatus.NO_CONTENT)
  public void delete(@PathVariable long id) {
    service.delete(id);
  }
}

========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\domain\Applicant.java ==========

package com.example.subsidy_management_api.domain;

public class Applicant {
  private Long id;
  private String fullName;
  private String fullNameKana;
  private String email;
  private String phone;
  private String postalCode;
  private String address1;
  private String address2;

  public Long getId() { return id; }
  public void setId(Long id) { this.id = id; }

  public String getFullName() { return fullName; }
  public void setFullName(String fullName) { this.fullName = fullName; }

  public String getFullNameKana() { return fullNameKana; }
  public void setFullNameKana(String fullNameKana) { this.fullNameKana = fullNameKana; }

  public String getEmail() { return email; }
  public void setEmail(String email) { this.email = email; }

  public String getPhone() { return phone; }
  public void setPhone(String phone) { this.phone = phone; }

  public String getPostalCode() { return postalCode; }
  public void setPostalCode(String postalCode) { this.postalCode = postalCode; }

  public String getAddress1() { return address1; }
  public void setAddress1(String address1) { this.address1 = address1; }

  public String getAddress2() { return address2; }
  public void setAddress2(String address2) { this.address2 = address2; }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\domain\ApplicationStatus.java ==========

package com.example.subsidy_management_api.domain;

public enum ApplicationStatus {
  APPLIED,
  APPROVED,
  PAID,
  REJECTED,
  CANCELED
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\domain\DocumentPayloadTemplate.java ==========

package com.example.subsidy_management_api.domain;

import java.util.List;
import java.util.Map;

public class DocumentPayloadTemplate {

  private static final Map<DocumentType, List<String>> REQUIRED_KEYS = Map.of(
      DocumentType.DECISION_NOTICE, List.of(
          "applicantFullName",
          "applicationDate",
          "amountRequested",
          "decisionDate",
          "approvedAmount"
      ),
      DocumentType.SETTLEMENT_NOTICE, List.of(
          "applicantFullName",
          "applicationDate",
          "amountRequested",
          "settlementDate",
          "approvedAmount"
      ),
      DocumentType.SURVEY_REQUEST, List.of(
          "applicantFullName",
          "applicationDate",
          "amountRequested",
          "surveyDueDate"
      )
  );

  public static List<String> requiredKeys(DocumentType type) {
    return REQUIRED_KEYS.getOrDefault(type, List.of());
  }

  private DocumentPayloadTemplate() {
    // utility class
  }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\domain\DocumentPayloadValidator.java ==========

package com.example.subsidy_management_api.domain;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;

public class DocumentPayloadValidator {

  public static void validateRequiredKeys(DocumentType type, Map<String, Object> payload) {
    List<String> required = DocumentPayloadTemplate.requiredKeys(type);
    if (required.isEmpty()) {
      return;
    }

    if (payload == null) {
      throw new IllegalArgumentException("payload is required for documentType=" + type);
    }

    List<String> missing = new ArrayList<>();
    for (String key : required) {
      Object value = payload.get(key);
      if (value == null) {
        missing.add(key);
        continue;
      }
      if (value instanceof String s && s.isBlank()) {
        missing.add(key);
      }
    }

    if (!missing.isEmpty()) {
      throw new IllegalArgumentException("payload is missing required keys: " + String.join(", ", missing));
    }
  }

  private DocumentPayloadValidator() {
    // utility class
  }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\domain\DocumentType.java ==========

package com.example.subsidy_management_api.domain;

public enum DocumentType {
  DECISION_NOTICE,     // 交付決定通知
  SETTLEMENT_NOTICE,   // 確定通知
  SURVEY_REQUEST       // 調査依頼
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\domain\SubsidyApplication.java ==========

package com.example.subsidy_management_api.domain;

import java.time.LocalDate;


public class SubsidyApplication {

  private Long id;
  private Long applicantId;
  private LocalDate applicationDate;
  private Long amountRequested;
  private ApplicationStatus status; // まずは String（最短）。後で enum 化する

  public Long getId() {
    return id;
  }

  public void setId(Long id) {
    this.id = id;
  }

  public Long getApplicantId() {
    return applicantId;
  }

  public void setApplicantId(Long applicantId) {
    this.applicantId = applicantId;
  }

  public LocalDate getApplicationDate() {
    return applicationDate;
  }

  public void setApplicationDate(LocalDate applicationDate) {
    this.applicationDate = applicationDate;
  }

  public Long getAmountRequested() {
    return amountRequested;
  }

  public void setAmountRequested(Long amountRequested) {
    this.amountRequested = amountRequested;
  }

  public ApplicationStatus getStatus() {
    return status;
  }

  public void setStatus(ApplicationStatus status) {
    this.status = status;
  }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\exception\NotFoundException.java ==========

package com.example.subsidy_management_api.exception;

public class NotFoundException extends RuntimeException {
  public NotFoundException(String message) {
    super(message);
  }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\mapper\ApplicantMapper.java ==========

package com.example.subsidy_management_api.mapper;

import com.example.subsidy_management_api.domain.Applicant;
import org.apache.ibatis.annotations.Mapper;

@Mapper
public interface ApplicantMapper {
  int insert(Applicant applicant); // useGeneratedKeys で applicant.id に採番が入る
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\mapper\DocumentDraftMapper.java ==========

package com.example.subsidy_management_api.mapper;

import com.example.subsidy_management_api.mapper.result.ApplicationDraftBaseRow;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

@Mapper
public interface DocumentDraftMapper {
  ApplicationDraftBaseRow findBaseByApplicationId(@Param("applicationId") long applicationId);
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\mapper\DocumentMapper.java ==========

package com.example.subsidy_management_api.mapper;

import com.example.subsidy_management_api.api.dto.DocumentListItem;
import com.example.subsidy_management_api.mapper.param.DocumentInsertParam;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

import java.util.List;

@Mapper
public interface DocumentMapper {

  int insert(DocumentInsertParam param);

  List<DocumentListItem> findByApplicationId(@Param("applicationId") long applicationId);
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\mapper\param\DocumentInsertParam.java ==========

package com.example.subsidy_management_api.mapper.param;

public class DocumentInsertParam {
  private Long id; // insert後にMyBatisがセットする（AUTO_INCREMENT）
  private long applicationId;
  private String documentType;
  private String documentNo;
  private String issuedBy;
  private String payloadJson;

  public Long getId() { return id; }
  public void setId(Long id) { this.id = id; }

  public long getApplicationId() { return applicationId; }
  public void setApplicationId(long applicationId) { this.applicationId = applicationId; }

  public String getDocumentType() { return documentType; }
  public void setDocumentType(String documentType) { this.documentType = documentType; }

  public String getDocumentNo() { return documentNo; }
  public void setDocumentNo(String documentNo) { this.documentNo = documentNo; }

  public String getIssuedBy() { return issuedBy; }
  public void setIssuedBy(String issuedBy) { this.issuedBy = issuedBy; }

  public String getPayloadJson() { return payloadJson; }
  public void setPayloadJson(String payloadJson) { this.payloadJson = payloadJson; }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\mapper\ReportMapper.java ==========

package com.example.subsidy_management_api.mapper;

import com.example.subsidy_management_api.api.dto.ReportStatusBreakdownItem;
import java.util.List;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

import java.time.LocalDate;

@Mapper
public interface ReportMapper {
  long countApplications(
      @Param("from") LocalDate from,
      @Param("to") LocalDate to,
      @Param("status") String status
  );

  Long sumAmountRequested(
      @Param("from") LocalDate from,
      @Param("to") LocalDate to,
      @Param("status") String status
  );

  List<ReportStatusBreakdownItem> breakdownByStatus(
      @Param("from") LocalDate from,
      @Param("to") LocalDate to
  );
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\mapper\result\ApplicationDraftBaseRow.java ==========

package com.example.subsidy_management_api.mapper.result;

import java.time.LocalDate;

public class ApplicationDraftBaseRow {
  private long applicationId;
  private String applicantFullName;
  private LocalDate applicationDate;
  private long amountRequested;

  public long getApplicationId() { return applicationId; }
  public void setApplicationId(long applicationId) { this.applicationId = applicationId; }

  public String getApplicantFullName() { return applicantFullName; }
  public void setApplicantFullName(String applicantFullName) { this.applicantFullName = applicantFullName; }

  public LocalDate getApplicationDate() { return applicationDate; }
  public void setApplicationDate(LocalDate applicationDate) { this.applicationDate = applicationDate; }

  public long getAmountRequested() { return amountRequested; }
  public void setAmountRequested(long amountRequested) { this.amountRequested = amountRequested; }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\mapper\SubsidyApplicationMapper.java ==========

package com.example.subsidy_management_api.mapper;

import com.example.subsidy_management_api.api.dto.SubsidyApplicationDetailResponse;
import com.example.subsidy_management_api.api.dto.SubsidyApplicationListItem;
import com.example.subsidy_management_api.domain.SubsidyApplication;
import java.time.LocalDate;
import java.util.List;
import java.util.Optional;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

@Mapper
public interface SubsidyApplicationMapper {

  int insert(SubsidyApplication application); // application.id に採番が入る

  // 一覧の総件数（ページング用）
  long countList(
      @Param("status") String status,
      @Param("from") LocalDate from,
      @Param("to") LocalDate to,
      @Param("q") String q
  );

  // 一覧取得（limit/offset/orderBy）
  List<SubsidyApplicationListItem> findList(
      @Param("status") String status,
      @Param("from") LocalDate from,
      @Param("to") LocalDate to,
      @Param("q") String q,
      @Param("limit") int limit,
      @Param("offset") int offset,
      @Param("orderBy") String orderBy
  );

  Optional<SubsidyApplicationDetailResponse> findDetailById(@Param("id") long id);

  int logicalDeleteById(@Param("id") long id);

  Integer existsActiveById(long id);
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\service\DocumentDraftService.java ==========

package com.example.subsidy_management_api.service;

import com.example.subsidy_management_api.api.dto.DocumentDraftResponse;
import com.example.subsidy_management_api.domain.DocumentPayloadTemplate;
import com.example.subsidy_management_api.domain.DocumentType;
import com.example.subsidy_management_api.exception.NotFoundException;
import com.example.subsidy_management_api.mapper.DocumentDraftMapper;
import com.example.subsidy_management_api.mapper.result.ApplicationDraftBaseRow;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Service
public class DocumentDraftService {

  private final DocumentDraftMapper mapper;

  public DocumentDraftService(DocumentDraftMapper mapper) {
    this.mapper = mapper;
  }

  @Transactional(readOnly = true)
  public DocumentDraftResponse draft(long applicationId, DocumentType documentType) {
    ApplicationDraftBaseRow row = mapper.findBaseByApplicationId(applicationId);
    if (row == null) {
      throw new NotFoundException("Application not found: id=" + applicationId);
    }

    // テンプレ必須キーを全て含める（足りないものは null）
    List<String> requiredKeys = DocumentPayloadTemplate.requiredKeys(documentType);
    Map<String, Object> payload = new HashMap<>();
    for (String key : requiredKeys) {
      payload.put(key, null);
    }

    // 共通の自動入力（テンプレに含まれている前提）
    payload.put("applicantFullName", row.getApplicantFullName());
    payload.put("applicationDate", row.getApplicationDate());
    payload.put("amountRequested", row.getAmountRequested());

    return new DocumentDraftResponse(applicationId, documentType.name(), payload);
  }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\service\DocumentIssueService.java ==========

package com.example.subsidy_management_api.service;

import com.example.subsidy_management_api.api.dto.DocumentIssueRequest;
import com.example.subsidy_management_api.api.dto.DocumentIssueResponse;
import com.example.subsidy_management_api.domain.DocumentPayloadTemplate;
import com.example.subsidy_management_api.domain.DocumentPayloadValidator;
import com.example.subsidy_management_api.domain.DocumentType;
import com.example.subsidy_management_api.exception.NotFoundException;
import com.example.subsidy_management_api.mapper.DocumentDraftMapper;
import com.example.subsidy_management_api.mapper.DocumentMapper;
import com.example.subsidy_management_api.mapper.param.DocumentInsertParam;
import com.example.subsidy_management_api.mapper.result.ApplicationDraftBaseRow;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.OffsetDateTime;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Service
public class DocumentIssueService {

  private final DocumentDraftMapper draftMapper;
  private final DocumentMapper documentMapper;
  private final ObjectMapper objectMapper;

  public DocumentIssueService(DocumentDraftMapper draftMapper,
      DocumentMapper documentMapper,
      ObjectMapper objectMapper) {
    this.draftMapper = draftMapper;
    this.documentMapper = documentMapper;
    this.objectMapper = objectMapper;
  }

  @Transactional
  public DocumentIssueResponse issue(DocumentIssueRequest req) {
    long applicationId = req.getApplicationId();
    DocumentType type = req.getDocumentType();

    // 1) Draftの元データ取得（申請 + 申請者）
    ApplicationDraftBaseRow row = draftMapper.findBaseByApplicationId(applicationId);
    if (row == null) {
      throw new NotFoundException("Application not found: id=" + applicationId);
    }

    // 2) テンプレ必須キーをすべて payload に含める（足りないものは null）
    List<String> requiredKeys = DocumentPayloadTemplate.requiredKeys(type);
    Map<String, Object> payload = new HashMap<>();
    for (String key : requiredKeys) {
      payload.put(key, null);
    }

    // 3) 共通自動入力（DBから）
    payload.put("applicantFullName", row.getApplicantFullName());
    payload.put("applicationDate", row.getApplicationDate());
    payload.put("amountRequested", row.getAmountRequested());

    // 4) overridesで上書き（不足分だけ渡す運用）
    Map<String, Object> overrides = req.getOverridesPayload();
    if (overrides != null) {
      for (Map.Entry<String, Object> e : overrides.entrySet()) {
        payload.put(e.getKey(), e.getValue());
      }
    }

    // 5) 必須キー検証（不足は 400 にしたいので IllegalArgumentException）
    DocumentPayloadValidator.validateRequiredKeys(type, payload);

    // 6) JSON化
    String payloadJson;
    try {
      payloadJson = objectMapper.writeValueAsString(payload);
    } catch (JsonProcessingException e) {
      throw new IllegalArgumentException("payload is not valid JSON");
    }

    // 7) 保存（documents）
    DocumentInsertParam param = new DocumentInsertParam();
    param.setApplicationId(applicationId);
    param.setDocumentType(type.name());
    param.setDocumentNo(req.getDocumentNo());
    param.setIssuedBy(req.getIssuedBy());
    param.setPayloadJson(payloadJson);

    documentMapper.insert(param);

    long documentId = (param.getId() == null) ? 0L : param.getId();

    return new DocumentIssueResponse(
        documentId,
        applicationId,
        type.name(),
        OffsetDateTime.now(),
        payload
    );
  }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\service\DocumentService.java ==========

package com.example.subsidy_management_api.service;

import com.example.subsidy_management_api.api.dto.DocumentCreateRequest;
import com.example.subsidy_management_api.api.dto.DocumentCreateResponse;
import com.example.subsidy_management_api.api.dto.DocumentListItem;
import com.example.subsidy_management_api.domain.DocumentPayloadValidator;
import com.example.subsidy_management_api.exception.NotFoundException;
import com.example.subsidy_management_api.mapper.DocumentMapper;
import com.example.subsidy_management_api.mapper.SubsidyApplicationMapper;
import com.example.subsidy_management_api.mapper.param.DocumentInsertParam;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import java.time.OffsetDateTime;
import java.util.List;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
public class DocumentService {

  private final DocumentMapper documentMapper;
  private final SubsidyApplicationMapper applicationMapper;
  private final ObjectMapper objectMapper;

  public DocumentService(DocumentMapper documentMapper,
      SubsidyApplicationMapper applicationMapper,
      ObjectMapper objectMapper) {
    this.documentMapper = documentMapper;
    this.applicationMapper = applicationMapper;
    this.objectMapper = objectMapper;
  }

  @Transactional
  public DocumentCreateResponse create(DocumentCreateRequest req) {
    Integer exists = applicationMapper.existsActiveById(req.getApplicationId());
    if (exists == null) {
      throw new NotFoundException("Application not found: id=" + req.getApplicationId());
    }

    DocumentPayloadValidator.validateRequiredKeys(req.getDocumentType(), req.getPayload());

    String payloadJson = null;
    if (req.getPayload() != null) {
      try {
        payloadJson = objectMapper.writeValueAsString(req.getPayload());
      } catch (JsonProcessingException e) {
        throw new IllegalArgumentException("payload is not valid JSON");
      }
    }

    DocumentInsertParam param = new DocumentInsertParam();
    param.setApplicationId(req.getApplicationId());
    param.setDocumentType(req.getDocumentType().name());
    param.setDocumentNo(req.getDocumentNo());
    param.setIssuedBy(req.getIssuedBy());
    param.setPayloadJson(payloadJson);

    documentMapper.insert(param);

    // MyBatisがAUTO_INCREMENTのidをparam.idにセットしてくれる
    long documentId = (param.getId() == null) ? 0L : param.getId();

    return new DocumentCreateResponse(
        documentId,
        req.getApplicationId(),
        req.getDocumentType().name(),
        OffsetDateTime.now()
    );
  }

  @Transactional(readOnly = true)
  public List<DocumentListItem> list(long applicationId) {
    return documentMapper.findByApplicationId(applicationId);
  }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\service\ReportService.java ==========

package com.example.subsidy_management_api.service;

import com.example.subsidy_management_api.api.dto.ReportStatusBreakdownItem;
import com.example.subsidy_management_api.api.dto.ReportSummaryResponse;
import com.example.subsidy_management_api.mapper.ReportMapper;
import java.time.LocalDate;
import java.util.List;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
public class ReportService {

  private final ReportMapper reportMapper;

  public ReportService(ReportMapper reportMapper) {
    this.reportMapper = reportMapper;
  }

  @Transactional(readOnly = true)
  public ReportSummaryResponse summary(String from, String to, String status) {
    LocalDate fromDate = (from == null || from.isBlank()) ? null : LocalDate.parse(from);
    LocalDate toDate = (to == null || to.isBlank()) ? null : LocalDate.parse(to);
    String st = (status == null || status.isBlank()) ? null : status;

    long count = reportMapper.countApplications(fromDate, toDate, st);
    Long sum = reportMapper.sumAmountRequested(fromDate, toDate, st);
    long total = (sum == null) ? 0L : sum;

    return new ReportSummaryResponse(fromDate, toDate, st, count, total);
  }

  @Transactional(readOnly = true)
  public List<ReportStatusBreakdownItem> breakdown(String from, String to) {
    LocalDate fromDate = (from == null || from.isBlank()) ? null : LocalDate.parse(from);
    LocalDate toDate = (to == null || to.isBlank()) ? null : LocalDate.parse(to);
    return reportMapper.breakdownByStatus(fromDate, toDate);
  }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\service\SubsidyApplicationService.java ==========

package com.example.subsidy_management_api.service;

import com.example.subsidy_management_api.api.dto.SubsidyApplicationCreateRequest;
import com.example.subsidy_management_api.api.dto.SubsidyApplicationCreateResponse;
import com.example.subsidy_management_api.api.dto.SubsidyApplicationDetailResponse;
import com.example.subsidy_management_api.api.dto.SubsidyApplicationListItem;
import com.example.subsidy_management_api.api.dto.SubsidyApplicationListResponse;
import com.example.subsidy_management_api.domain.Applicant;
import com.example.subsidy_management_api.domain.SubsidyApplication;
import com.example.subsidy_management_api.exception.NotFoundException;
import com.example.subsidy_management_api.mapper.ApplicantMapper;
import com.example.subsidy_management_api.mapper.SubsidyApplicationMapper;
import java.time.LocalDate;
import java.util.List;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
public class SubsidyApplicationService {

  private final ApplicantMapper applicantMapper;
  private final SubsidyApplicationMapper applicationMapper;

  public SubsidyApplicationService(ApplicantMapper applicantMapper,
      SubsidyApplicationMapper applicationMapper) {
    this.applicantMapper = applicantMapper;
    this.applicationMapper = applicationMapper;
  }

  @Transactional
  public SubsidyApplicationCreateResponse create(SubsidyApplicationCreateRequest request) {
    // 1) applicants
    Applicant applicant = new Applicant();
    applicant.setFullName(request.getApplicant().getFullName());
    applicant.setFullNameKana(request.getApplicant().getFullNameKana());
    applicant.setEmail(request.getApplicant().getEmail());
    applicant.setPhone(request.getApplicant().getPhone());
    applicant.setPostalCode(request.getApplicant().getPostalCode());
    applicant.setAddress1(request.getApplicant().getAddress1());
    applicant.setAddress2(request.getApplicant().getAddress2());

    applicantMapper.insert(applicant); // ← ここで applicant.id が採番される

    // 2) subsidy_applications
    SubsidyApplication app = new SubsidyApplication();
    app.setApplicantId(applicant.getId());
    app.setApplicationDate(LocalDate.parse(request.getApplication().getApplicationDate()));
    app.setAmountRequested(request.getApplication().getAmountRequested());
    app.setStatus(request.getApplication().getStatus());

    applicationMapper.insert(app); // ← ここで app.id が採番される

    return new SubsidyApplicationCreateResponse(applicant.getId(), app.getId());
  }

  @Transactional(readOnly = true)
  public SubsidyApplicationListResponse findList(
      String status,
      String from,
      String to,
      String q,
      Integer limit,
      Integer offset,
      String sort
  ) {
    LocalDate fromDate = (from == null || from.isBlank()) ? null : LocalDate.parse(from);
    LocalDate toDate = (to == null || to.isBlank()) ? null : LocalDate.parse(to);
    String keyword = (q == null || q.isBlank()) ? null : q;
    String st = (status == null || status.isBlank()) ? null : status;

    // ✅ lim/off を作る（未指定ならデフォルト）
    int lim = (limit == null) ? 20 : limit;
    int off = (offset == null) ? 0 : offset;
    if (lim <= 0) throw new IllegalArgumentException("limit must be positive");
    if (off < 0) throw new IllegalArgumentException("offset must be >= 0");

    // ✅ sort → orderBy を作る（ホワイトリスト変換）
    String sortRaw = (sort == null || sort.isBlank()) ? "applicationDate,desc" : sort;
    String orderBy = toSafeOrderBy(sortRaw);

    // ✅ count + select
    long total = applicationMapper.countList(st, fromDate, toDate, keyword);
    List<SubsidyApplicationListItem> items =
        applicationMapper.findList(st, fromDate, toDate, keyword, lim, off, orderBy);

    return new SubsidyApplicationListResponse(items, total, lim, off, sortRaw);
  }


  @Transactional(readOnly = true)
  public SubsidyApplicationDetailResponse findDetail(long id) {
    return applicationMapper.findDetailById(id)
        .orElseThrow(() -> new NotFoundException("Application not found: id=" + id));
  }

  @Transactional
  public void delete(long id) {
    int updated = applicationMapper.logicalDeleteById(id);
    if (updated == 0) {
      throw new NotFoundException("Application not found or already deleted: id=" + id);
    }
  }

  /**
   * sort（例: applicationDate,desc）を安全な ORDER BY 句の固定文字列に変換する。
   * 許可カラム：applicationDate / createdAt
   * 許可方向：asc / desc
   */
  private String toSafeOrderBy(String sort) {
    String[] parts = sort.split(",", -1);
    if (parts.length != 2) {
      throw new IllegalArgumentException(
          "sort must be like 'applicationDate,desc' or 'createdAt,asc'");
    }

    String column = parts[0].trim();
    String direction = parts[1].trim().toLowerCase();

    String sqlColumn;
    switch (column) {
      case "applicationDate":
        sqlColumn = "sa.application_date";
        break;
      case "createdAt":
        sqlColumn = "sa.created_at";
        break;
      default:
        throw new IllegalArgumentException("sort column is not allowed: " + column);
    }

    String sqlDirection;
    switch (direction) {
      case "asc":
        sqlDirection = "ASC";
        break;
      case "desc":
        sqlDirection = "DESC";
        break;
      default:
        throw new IllegalArgumentException("sort direction is invalid: " + direction);
    }

    return sqlColumn + " " + sqlDirection;
  }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\ServletInitializer.java ==========

package com.example.subsidy_management_api;

import org.springframework.boot.builder.SpringApplicationBuilder;
import org.springframework.boot.web.servlet.support.SpringBootServletInitializer;

public class ServletInitializer extends SpringBootServletInitializer {

	@Override
	protected SpringApplicationBuilder configure(SpringApplicationBuilder application) {
		return application.sources(SubsidyManagementApiApplication.class);
	}

}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\java\com\example\subsidy_management_api\SubsidyManagementApiApplication.java ==========

package com.example.subsidy_management_api;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class SubsidyManagementApiApplication {

	public static void main(String[] args) {
		SpringApplication.run(SubsidyManagementApiApplication.class, args);
	}

}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\resources\application-local.yml ==========

spring:
  datasource:
    url: jdbc:mysql://localhost:${MYSQL_PORT:3306}/${MYSQL_DATABASE:subsidy}?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Tokyo
    username: ${MYSQL_USER:app}
    password: ${MYSQL_PASSWORD:apppass}

mybatis:
  mapper-locations: classpath*:mapper/**/*.xml


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\resources\db\migration\V1__init.sql ==========



CREATE TABLE applicants (
  id BIGINT NOT NULL AUTO_INCREMENT,
  full_name VARCHAR(100) NOT NULL,
  full_name_kana VARCHAR(100) NULL,
  email VARCHAR(255) NULL,
  phone VARCHAR(50) NULL,
  postal_code VARCHAR(20) NULL,
  address1 VARCHAR(255) NULL,
  address2 VARCHAR(255) NULL,
  created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
  updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
  deleted_at DATETIME(6) NULL,
  PRIMARY KEY (id),
  INDEX idx_applicants_deleted_at (deleted_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE subsidy_applications (
  id BIGINT NOT NULL AUTO_INCREMENT,
  applicant_id BIGINT NOT NULL,
  application_date DATE NOT NULL,
  amount_requested BIGINT NOT NULL,
  status VARCHAR(20) NOT NULL,
  decision_date DATE NULL,
  approved_amount BIGINT NULL,
  paid_date DATE NULL,
  note TEXT NULL,
  created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
  updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
  deleted_at DATETIME(6) NULL,
  PRIMARY KEY (id),
  CONSTRAINT fk_applications_applicant
    FOREIGN KEY (applicant_id) REFERENCES applicants(id),
  INDEX idx_applications_applicant_id (applicant_id),
  INDEX idx_applications_status (status),
  INDEX idx_applications_application_date (application_date),
  INDEX idx_applications_deleted_at (deleted_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE documents (
  id BIGINT NOT NULL AUTO_INCREMENT,
  application_id BIGINT NOT NULL,
  document_type VARCHAR(30) NOT NULL,
  document_no VARCHAR(50) NULL,
  issued_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
  issued_by VARCHAR(100) NULL,
  payload_json JSON NULL,
  created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
  updated_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
  deleted_at DATETIME(6) NULL,
  PRIMARY KEY (id),
  CONSTRAINT fk_documents_application
    FOREIGN KEY (application_id) REFERENCES subsidy_applications(id),
  INDEX idx_documents_application_id (application_id),
  INDEX idx_documents_type (document_type),
  INDEX idx_documents_issued_at (issued_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE audit_logs (
  id BIGINT NOT NULL AUTO_INCREMENT,
  actor VARCHAR(100) NOT NULL,
  action VARCHAR(30) NOT NULL,
  entity_type VARCHAR(50) NOT NULL,
  entity_id BIGINT NULL,
  detail_json JSON NULL,
  created_at DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
  PRIMARY KEY (id),
  INDEX idx_audit_created_at (created_at),
  INDEX idx_audit_entity (entity_type, entity_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\resources\mapper\ApplicantMapper.xml ==========

<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.subsidy_management_api.mapper.ApplicantMapper">

  <insert id="insert"
    parameterType="com.example.subsidy_management_api.domain.Applicant"
    useGeneratedKeys="true"
    keyProperty="id">
    INSERT INTO applicants (
    full_name,
    full_name_kana,
    email,
    phone,
    postal_code,
    address1,
    address2
    ) VALUES (
    #{fullName},
    #{fullNameKana},
    #{email},
    #{phone},
    #{postalCode},
    #{address1},
    #{address2}
    )
  </insert>

</mapper>


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\resources\mapper\DocumentDraftMapper.xml ==========

<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.subsidy_management_api.mapper.DocumentDraftMapper">

  <select id="findBaseByApplicationId"
    resultType="com.example.subsidy_management_api.mapper.result.ApplicationDraftBaseRow">
    SELECT
    sa.id AS applicationId,
    a.full_name AS applicantFullName,
    sa.application_date AS applicationDate,
    sa.amount_requested AS amountRequested
    FROM subsidy_applications sa
    JOIN applicants a ON a.id = sa.applicant_id
    WHERE sa.id = #{applicationId}
    AND sa.deleted_at IS NULL
    AND a.deleted_at IS NULL
    LIMIT 1
  </select>

</mapper>


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\resources\mapper\DocumentMapper.xml ==========

<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.subsidy_management_api.mapper.DocumentMapper">

  <insert id="insert"
    useGeneratedKeys="true"
    keyProperty="id"
    keyColumn="id">
    INSERT INTO documents
    (application_id, document_type, document_no, issued_by, payload_json)
    VALUES
    (#{applicationId}, #{documentType}, #{documentNo}, #{issuedBy}, #{payloadJson})
  </insert>

  <select id="findByApplicationId" resultType="com.example.subsidy_management_api.api.dto.DocumentListItem">
    SELECT
    d.id AS documentId,
    d.application_id AS applicationId,
    d.document_type AS documentType,
    d.document_no AS documentNo,
    d.issued_by AS issuedBy,
    d.issued_at AS issuedAt
    FROM documents d
    WHERE d.application_id = #{applicationId}
    AND d.deleted_at IS NULL
    ORDER BY d.issued_at DESC, d.id DESC
  </select>

</mapper>


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\resources\mapper\ReportMapper.xml ==========

<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.subsidy_management_api.mapper.ReportMapper">

  <select id="countApplications" resultType="long">
    SELECT COUNT(*)
    FROM subsidy_applications sa
    WHERE sa.deleted_at IS NULL
    <if test="from != null">
      AND sa.application_date &gt;= #{from}
    </if>
    <if test="to != null">
      AND sa.application_date &lt;= #{to}
    </if>
    <if test="status != null and status != ''">
      AND sa.status = #{status}
    </if>
  </select>

  <select id="sumAmountRequested" resultType="long">
    SELECT SUM(sa.amount_requested)
    FROM subsidy_applications sa
    WHERE sa.deleted_at IS NULL
    <if test="from != null">
      AND sa.application_date &gt;= #{from}
    </if>
    <if test="to != null">
      AND sa.application_date &lt;= #{to}
    </if>
    <if test="status != null and status != ''">
      AND sa.status = #{status}
    </if>
  </select>

  <select id="breakdownByStatus" resultType="com.example.subsidy_management_api.api.dto.ReportStatusBreakdownItem">
    SELECT
    sa.status AS status,
    COUNT(*) AS count,
    COALESCE(SUM(sa.amount_requested), 0) AS totalAmountRequested
    FROM subsidy_applications sa
    WHERE sa.deleted_at IS NULL
    <if test="from != null">
      AND sa.application_date &gt;= #{from}
    </if>
    <if test="to != null">
      AND sa.application_date &lt;= #{to}
    </if>
    GROUP BY sa.status
    ORDER BY sa.status ASC
  </select>
</mapper>


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\main\resources\mapper\SubsidyApplicationMapper.xml ==========

<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.subsidy_management_api.mapper.SubsidyApplicationMapper">

  <!-- ✅ COUNT（total取得） -->
  <select id="countList" resultType="long">
    SELECT COUNT(*)
    FROM subsidy_applications sa
    JOIN applicants a ON a.id = sa.applicant_id
    <where>
      sa.deleted_at IS NULL
      AND a.deleted_at IS NULL

      <if test="status != null">
        AND sa.status = #{status}
      </if>

      <if test="from != null">
        AND sa.application_date <![CDATA[>=]]> #{from}
      </if>

      <if test="to != null">
        AND sa.application_date <![CDATA[<=]]> #{to}
      </if>

      <if test="q != null">
        AND (
        a.full_name LIKE CONCAT('%', #{q}, '%')
        OR a.email LIKE CONCAT('%', #{q}, '%')
        )
      </if>
    </where>
  </select>

  <!-- ✅ SELECT（items取得：ページング＋ソート） -->
  <select id="findList"
    resultType="com.example.subsidy_management_api.api.dto.SubsidyApplicationListItem">
    SELECT
    sa.id AS applicationId,
    sa.applicant_id AS applicantId,
    a.full_name AS applicantFullName,
    sa.application_date AS applicationDate,
    sa.amount_requested AS amountRequested,
    sa.status AS status
    FROM subsidy_applications sa
    JOIN applicants a ON a.id = sa.applicant_id
    <where>
      sa.deleted_at IS NULL
      AND a.deleted_at IS NULL

      <if test="status != null">
        AND sa.status = #{status}
      </if>

      <if test="from != null">
        AND sa.application_date <![CDATA[>=]]> #{from}
      </if>

      <if test="to != null">
        AND sa.application_date <![CDATA[<=]]> #{to}
      </if>

      <if test="q != null">
        AND (
        a.full_name LIKE CONCAT('%', #{q}, '%')
        OR a.email LIKE CONCAT('%', #{q}, '%')
        )
      </if>
    </where>

    <!-- orderBy は Service 側でホワイトリスト変換した固定文字列のみを渡す -->
    ORDER BY ${orderBy}
    LIMIT #{limit} OFFSET #{offset}
  </select>

</mapper>


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\test\java\com\example\subsidy_management_api\api\SubsidyApplicationControllerTest.java ==========

package com.example.subsidy_management_api.api;

import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.eq;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.delete;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

import com.example.subsidy_management_api.exception.NotFoundException;
import com.example.subsidy_management_api.service.SubsidyApplicationService;
import org.junit.jupiter.api.Test;
import org.mockito.Mockito;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.http.MediaType;
import org.springframework.test.context.bean.override.mockito.MockitoBean;
import org.springframework.test.web.servlet.MockMvc;

@WebMvcTest(SubsidyApplicationController.class)
class SubsidyApplicationControllerTest {

  @Autowired
  private MockMvc mockMvc;

  @MockitoBean
  private SubsidyApplicationService service;


  @Test
  void create_returns201_whenValid() throws Exception {
    // service.create(...) が成功する前提（戻り値がある場合は適宜合わせる）
    // 例：createがSubsidyApplicationCreateResponseを返すなら、その型でthenReturnする
    Mockito.when(service.create(any())).thenReturn(
        // ここはあなたの実装のレスポンスDTOに合わせてください
        // new SubsidyApplicationCreateResponse(1L, 10L)
        null
    );

    String body = """
        {
          "applicant": {
            "fullName": "佐藤花子",
            "email": "hanako@example.com"
          },
          "application": {
            "applicationDate": "2026-01-05",
            "amountRequested": 150000,
            "status": "APPLIED"
          }
        }
        """;

    mockMvc.perform(post("/subsidy-applications")
            .contentType(MediaType.APPLICATION_JSON)
            .content(body))
        .andExpect(status().isCreated());
  }

  @Test
  void create_returns400_whenInvalid() throws Exception {
    // fullName が空 → validation で 400 を期待（あなたのDTOに@NotBlankがある前提）
    String body = """
        {
          "applicant": {
            "fullName": "",
            "email": "hanako@example.com"
          },
          "application": {
            "applicationDate": "2026-01-05",
            "amountRequested": 150000,
            "status": "APPLIED"
          }
        }
        """;

    mockMvc.perform(post("/subsidy-applications")
            .contentType(MediaType.APPLICATION_JSON)
            .content(body))
        .andDo(org.springframework.test.web.servlet.result.MockMvcResultHandlers.print())
        .andExpect(status().isBadRequest());
  }

  @Test
  void detail_returns404_whenNotFound() throws Exception {
    Mockito.when(service.findDetail(eq(999L)))
        .thenThrow(new NotFoundException("not found"));

    mockMvc.perform(get("/subsidy-applications/999"))
        .andExpect(status().isNotFound());
  }

  @Test
  void delete_returns404_whenNotFound() throws Exception {
    Mockito.doThrow(new NotFoundException("not found"))
        .when(service).delete(eq(999L));

    mockMvc.perform(delete("/subsidy-applications/999"))
        .andExpect(status().isNotFound());
  }
}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\test\java\com\example\subsidy_management_api\service\SubsidyApplicationServiceTest.java ==========

package com.example.subsidy_management_api.service;

public class SubsidyApplicationServiceTest {

}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\test\java\com\example\subsidy_management_api\SubsidyManagementApiApplicationTests.java ==========

package com.example.subsidy_management_api;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class SubsidyManagementApiApplicationTests {

	@Test
	void contextLoads() {
	}

}


========== END ==========


========== FILE: C:\Users\oto01\IdeaProjects\subsidy-management-api\src\test\resources\application.yml ==========

spring:
  datasource:
    url: jdbc:h2:mem:testdb;MODE=MySQL;DB_CLOSE_DELAY=-1;DATABASE_TO_UPPER=false
    driver-class-name: org.h2.Driver
    username: sa
    password:

  flyway:
    enabled: false


========== END ==========

